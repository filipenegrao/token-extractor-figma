<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Token Extractor</title>
  <style>
    /* ── Reset & Base ── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #1e1e1e;
      --surface: #2a2a2a;
      --surface2: #333;
      --border: #3a3a3a;
      --text: #e8e8e8;
      --text-muted: #888;
      --accent: #7c6af7;
      --accent-hover: #9b8fff;
      --success: #4caf82;
      --error: #f47067;
      --warning: #e8a838;
      --radius: 6px;
      --radius-sm: 4px;
      font-size: 12px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 0;
      min-height: 100vh;
    }

    /* ── Layout ── */
    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      padding: 14px 16px 10px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    header h1 {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.2px;
    }

    header .badge {
      background: var(--accent);
      color: #fff;
      font-size: 9px;
      font-weight: 700;
      padding: 1px 5px;
      border-radius: 10px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .main {
      flex: 1;
      overflow-y: auto;
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* ── Controls ── */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    select, input[type="text"] {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 7px 10px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      width: 100%;
      outline: none;
      transition: border-color 0.15s;
      appearance: none;
      -webkit-appearance: none;
    }

    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23888'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 28px;
      cursor: pointer;
    }

    select:focus, input[type="text"]:focus {
      border-color: var(--accent);
    }

    /* ── Buttons ── */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: background 0.15s, opacity 0.15s, color 0.15s;
      width: 100%;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }

    .btn-secondary {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover:not(:disabled) { background: #3c3c3c; }

    .btn-success {
      background: var(--success);
      color: #fff;
    }
    .btn-success:hover:not(:disabled) { background: #5cc994; }

    .btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .btn-icon {
      font-size: 14px;
    }

    /* ── Color List ── */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .section-title {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .color-count {
      font-size: 10px;
      background: var(--surface2);
      color: var(--text-muted);
      padding: 1px 6px;
      border-radius: 10px;
    }

    .color-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .color-item {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      transition: border-color 0.15s;
    }

    .color-item:hover { border-color: var(--accent); }

    .remove-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
      padding: 2px 4px;
      border-radius: var(--radius-sm);
      flex-shrink: 0;
      line-height: 1;
      transition: color 0.15s, background 0.15s;
    }
    .remove-btn:hover { color: var(--error); background: #f4706722; }

    .color-swatch {
      width: 28px;
      height: 28px;
      border-radius: var(--radius-sm);
      flex-shrink: 0;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .color-info {
      flex: 1;
      min-width: 0;
    }

    .color-hex {
      font-size: 10px;
      color: var(--text-muted);
      font-family: "SF Mono", "Fira Code", monospace;
    }

    .token-input {
      background: transparent;
      border: none;
      border-bottom: 1px solid transparent;
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
      padding: 1px 0;
      width: 100%;
      outline: none;
      transition: border-color 0.15s;
    }

    .token-input:focus {
      border-bottom-color: var(--accent);
    }

    .source-badge {
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 5px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .source-fill   { background: #3b4aff22; color: #7c8fff; }
    .source-stroke { background: #ff8c3b22; color: #ffaa6a; }
    .source-text   { background: #3bff8c22; color: #6affaa; }

    /* ── Status ── */
    .status {
      font-size: 11px;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-info    { background: #7c6af722; color: #b0a4ff; border: 1px solid #7c6af744; }
    .status-success { background: #4caf8222; color: #7ddba8; border: 1px solid #4caf8244; }
    .status-error   { background: #f4706722; color: #f9a09a; border: 1px solid #f4706744; }
    .status-warning { background: #e8a83822; color: #f0c47a; border: 1px solid #e8a83844; }

    /* ── Toast (feedback flutuante para ações) ── */
    #toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%) translateY(12px);
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 11px;
      padding: 8px 14px;
      border-radius: 20px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s, transform 0.2s;
      z-index: 100;
    }
    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    #toast.toast-success { border-color: var(--success); color: #7ddba8; }
    #toast.toast-error   { border-color: var(--error);   color: #f9a09a; }

    .hidden { display: none !important; }

    /* ── Empty State ── */
    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-muted);
    }

    .empty-state .icon {
      font-size: 32px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 12px;
      line-height: 1.5;
    }

    /* ── Divider ── */
    .divider {
      height: 1px;
      background: var(--border);
    }

    /* ── Scrollbar ── */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Token Extractor</h1>
    <span class="badge">Beta</span>
    <button class="btn btn-secondary hidden" id="clearBtn" style="width: auto; padding: 4px 10px; margin-left: auto; font-size: 11px;">✕ Clear</button>
  </header>

  <div class="main">
    <!-- Controls -->
    <div class="controls">
      <div class="field">
        <label>Naming Pattern</label>
        <select id="pattern">
          <option value="tailwind">Tailwind CSS</option>
          <option value="material">Material Design 3</option>
          <option value="antd">Ant Design</option>
          <option value="wcag">WCAG / Accessible</option>
          <option value="custom">Custom Prefix</option>
        </select>
      </div>

      <div class="field hidden" id="customPrefixField">
        <label>Custom Prefix</label>
        <input type="text" id="customPrefix" placeholder="e.g. ds, brand, app" value="ds" />
      </div>

      <button class="btn btn-primary" id="extractBtn">
        <span class="btn-icon">⬡</span> Extract Colors from Selection
      </button>
    </div>

    <!-- Status (extração) -->
    <div id="status" class="status status-info hidden"></div>

    <!-- Color list section -->
    <div id="colorSection" class="hidden">
      <div class="section-header">
        <span class="section-title">Extracted Tokens</span>
        <span class="color-count" id="colorCount">0</span>
      </div>

      <div class="color-list" id="colorList"></div>

      <div style="margin-top: 10px;">
        <button class="btn btn-secondary" id="reapplyBtn">
          ↺ Re-apply naming pattern
        </button>
      </div>
    </div>

    <!-- Export section -->
    <div id="exportSection" class="hidden">
      <div class="divider" style="margin-bottom: 14px;"></div>

      <div class="btn-row">
        <button class="btn btn-success" id="exportVarsBtn">
          <span class="btn-icon">◈</span> Export to Variables
        </button>
        <button class="btn btn-secondary" id="copyJsonBtn">
          <span class="btn-icon">{}</span> Copy JSON
        </button>
      </div>
    </div>

    <!-- Empty state (initial) -->
    <div id="emptyState" class="empty-state">
      <div class="icon">◎</div>
      <p>Select one or more elements in Figma,<br>then click <strong>Extract Colors</strong>.</p>
    </div>
  </div>
</div>

<!-- Toast de feedback -->
<div id="toast"></div>

<script>
  // ── State ──────────────────────────────────────────────────────────────────
  let currentColors  = [];
  let currentPattern = 'tailwind';
  let pendingCopy    = false; // aguardando json-ready para copiar
  let toastTimer     = null;

  // ── DOM refs ───────────────────────────────────────────────────────────────
  const patternSelect     = document.getElementById('pattern');
  const customPrefixField = document.getElementById('customPrefixField');
  const customPrefixInput = document.getElementById('customPrefix');
  const extractBtn        = document.getElementById('extractBtn');
  const reapplyBtn        = document.getElementById('reapplyBtn');
  const clearBtn          = document.getElementById('clearBtn');
  const exportVarsBtn     = document.getElementById('exportVarsBtn');
  const copyJsonBtn       = document.getElementById('copyJsonBtn');
  const statusEl          = document.getElementById('status');
  const colorSection      = document.getElementById('colorSection');
  const exportSection     = document.getElementById('exportSection');
  const emptyState        = document.getElementById('emptyState');
  const colorList         = document.getElementById('colorList');
  const colorCount        = document.getElementById('colorCount');
  const toast             = document.getElementById('toast');

  // ── Toast ──────────────────────────────────────────────────────────────────
  function showToast(message, type = 'success') {
    if (toastTimer) clearTimeout(toastTimer);
    toast.textContent = message;
    toast.className = `show toast-${type}`;
    toastTimer = setTimeout(() => {
      toast.className = '';
    }, 2500);
  }

  // ── Status (extração) ─────────────────────────────────────────────────────
  let statusTimer = null;
  function showStatus(message, type = 'info', autohide = false) {
    if (statusTimer) clearTimeout(statusTimer);
    statusEl.textContent = message;
    statusEl.className = `status status-${type}`;
    statusEl.classList.remove('hidden');
    if (autohide) {
      statusTimer = setTimeout(() => statusEl.classList.add('hidden'), 3000);
    }
  }

  function hideStatus() {
    statusEl.classList.add('hidden');
  }

  // ── Clipboard (compatível com iframe do Figma) ────────────────────────────
  function copyToClipboard(text) {
    // Tenta a API moderna primeiro; se falhar (sem permissão no iframe), usa fallback
    if (navigator.clipboard && navigator.clipboard.writeText) {
      return navigator.clipboard.writeText(text).catch(() => fallbackCopy(text));
    }
    return Promise.resolve(fallbackCopy(text));
  }

  function fallbackCopy(text) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;top:0;left:0;width:1px;height:1px;opacity:0;';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try { document.execCommand('copy'); } catch (_) {}
    document.body.removeChild(ta);
  }

  // ── Loading states ────────────────────────────────────────────────────────
  function setLoading(loading) {
    extractBtn.disabled = loading;
  }

  function setExportLoading(loading) {
    exportVarsBtn.disabled = loading;
    copyJsonBtn.disabled   = loading;
  }

  // ── Reset ─────────────────────────────────────────────────────────────────
  function resetUI() {
    currentColors = [];
    pendingCopy   = false;
    colorList.innerHTML = '';
    colorSection.classList.add('hidden');
    exportSection.classList.add('hidden');
    emptyState.classList.remove('hidden');
    clearBtn.classList.add('hidden');
    hideStatus();
  }

  // ── Render color list ─────────────────────────────────────────────────────
  function renderColorList(colors) {
    colorList.innerHTML = '';

    colors.forEach((color, index) => {
      const item = document.createElement('div');
      item.className = 'color-item';

      const alpha = color.a < 1 ? ` ${Math.round(color.a * 100)}%` : '';

      item.innerHTML = `
        <div class="color-swatch" style="background:${color.hex}; opacity:${color.a};"></div>
        <div class="color-info">
          <input
            class="token-input"
            type="text"
            value="${color.tokenName}"
            data-index="${index}"
            spellcheck="false"
          />
          <div class="color-hex">${color.hex}${alpha}</div>
        </div>
        <span class="source-badge source-${color.source}">${color.source}</span>
        <button class="remove-btn" data-index="${index}" title="Remove this token">✕</button>
      `;

      colorList.appendChild(item);
    });

    // Live rename
    colorList.querySelectorAll('.token-input').forEach(input => {
      input.addEventListener('input', e => {
        const idx = parseInt(e.target.dataset.index);
        currentColors[idx].tokenName = e.target.value;
      });
    });

    // Remove individual
    colorList.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const idx = parseInt(e.currentTarget.dataset.index);
        currentColors.splice(idx, 1);
        if (currentColors.length === 0) {
          resetUI();
        } else {
          colorCount.textContent = currentColors.length;
          renderColorList(currentColors);
        }
      });
    });
  }

  // ── Messaging helpers ─────────────────────────────────────────────────────
  function postMsg(msg) {
    parent.postMessage({ pluginMessage: msg }, '*');
  }

  function applyNaming() {
    postMsg({
      type: 'apply-naming',
      colors: currentColors,
      pattern: currentPattern,
      customPrefix: customPrefixInput.value,
    });
  }

  // ── Event Listeners ────────────────────────────────────────────────────────
  patternSelect.addEventListener('change', () => {
    currentPattern = patternSelect.value;
    customPrefixField.classList.toggle('hidden', currentPattern !== 'custom');
    if (currentColors.length > 0) applyNaming();
  });

  customPrefixInput.addEventListener('input', () => {
    if (currentColors.length > 0 && currentPattern === 'custom') applyNaming();
  });

  extractBtn.addEventListener('click', () => {
    setLoading(true);
    hideStatus();
    postMsg({
      type: 'extract-colors',
      pattern: currentPattern,
      customPrefix: customPrefixInput.value,
    });
  });

  reapplyBtn.addEventListener('click', applyNaming);
  clearBtn.addEventListener('click', resetUI);

  exportVarsBtn.addEventListener('click', () => {
    if (!currentColors.length) return;
    setExportLoading(true);
    postMsg({ type: 'export-variables', colors: currentColors, pattern: currentPattern });
  });

  copyJsonBtn.addEventListener('click', () => {
    if (!currentColors.length) return;
    copyJsonBtn.disabled = true;
    copyJsonBtn.textContent = '…';
    pendingCopy = true;
    postMsg({ type: 'export-json', colors: currentColors, pattern: currentPattern });
  });

  // ── Plugin Messages ────────────────────────────────────────────────────────
  window.onmessage = (event) => {
    const msg = event.data.pluginMessage;
    if (!msg) return;

    switch (msg.type) {

      case 'no-selection':
        setLoading(false);
        showStatus('⚠ No elements selected. Select one or more layers first.', 'warning');
        break;

      case 'colors-extracted': {
        const isFirst = msg.source === 'extract';
        setLoading(false);
        currentColors = msg.colors;

        if (currentColors.length === 0) {
          showStatus('No solid colors found in the selected elements.', 'warning');
          colorSection.classList.add('hidden');
          exportSection.classList.add('hidden');
          emptyState.classList.remove('hidden');
          break;
        }

        emptyState.classList.add('hidden');
        colorSection.classList.remove('hidden');
        exportSection.classList.remove('hidden');
        clearBtn.classList.remove('hidden');
        colorCount.textContent = currentColors.length;
        renderColorList(currentColors);

        if (isFirst) {
          showStatus(
            `✓ ${currentColors.length} unique color${currentColors.length !== 1 ? 's' : ''} extracted.`,
            'success',
            true
          );
        }
        break;
      }

      case 'json-ready':
        if (pendingCopy) {
          pendingCopy = false;
          copyToClipboard(msg.json).then(() => {
            showToast('✓ JSON copied to clipboard!', 'success');
          }).catch(() => {
            showToast('✗ Could not copy — try again.', 'error');
          });
          copyJsonBtn.disabled  = false;
          copyJsonBtn.innerHTML = '<span class="btn-icon">{}</span> Copy JSON';
        }
        break;

      case 'export-done':
        setExportLoading(false);
        showToast(`✓ ${msg.count} variable${msg.count !== 1 ? 's' : ''} exported to Figma Variables!`, 'success');
        break;

      case 'export-error':
        setExportLoading(false);
        showToast(`✗ Error: ${msg.message}`, 'error');
        break;
    }
  };
</script>
</body>
</html>
